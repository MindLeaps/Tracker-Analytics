<head>
  <script src="https://code.highcharts.com/highcharts.js"></script>
</head>
<h1>Analytics (Subject)</h1>
<%#= @selected_student_id.class %>

<%= form_tag do %>
    <table>
      <tr>
        <td style="padding-right: 20px;">
          <%= label_tag :organization_label, "Organization" %>
          <%= select_tag :organization_select, options_from_collection_for_select(@organizations, :id, :organization_name, @selected_organization_id) %>
        </td>
        <td style="padding-right: 20px;">
          <%= label_tag :chapter_label, "Chapter" %>
          <%= select_tag :chapter_select, options_from_collection_for_select(@chapters, :id, :chapter_name, @selected_chapter_id), :prompt => 'All' %>
        </td>
        <td style="padding-right: 20px;">
          <%= label_tag :group_label, "Group" %>
          <%= select_tag :group_select, options_from_collection_for_select(@groups, :id, :group_name, @selected_group_id), :prompt => 'All' %>
        </td>
        <td style="padding-right: 20px;">
          <%= label_tag :student_label, "Student" %>
          <%= select_tag :student_select, options_from_collection_for_select(@students, :id, :proper_name, @selected_student_id), :prompt => 'All' %>
        </td>
        <td style="padding-right: 20px;">
          <%= label_tag :subject_label, "Subject" %>
          <%= select_tag :subject_select, options_from_collection_for_select(@subjects, :id, :subject_name, @subject) %>
        </td>
        <td style="padding-right: 20px;">
          <%= submit_tag "Submit" %>
        </td>
      </tr>
    </table>
<% end %>

<table id="trellis" style="width: 100%; table-layout: fixed;">
  <% rows = (@count + 1)/2 %>
  <% rows.times do %>
      <tr>
        <td></td>
        <td></td>
      </tr>
  <% end %>
</table>

<script>

    $('#organization_select').change(function () {

        var selectedOrganization = $('#organization_select :selected').val();
//        console.log(selectedOrganization)

        $.ajax({
            url: '<%=find_update_chapters_path%>',
            type: 'GET',
            dataType: 'json',
            data: {
                organization_id: selectedOrganization
            },
            success: function (data) {
                var chapters = data.chapters;
                debugger;

                $('#chapter_select').empty();
                var opt = document.createElement('option');
                opt.text = 'All';
                $('#chapter_select').append(opt, null);

                for (i = 0; i < chapters.length; i++) {
                    var chapter = chapters[i];

                    var opt = document.createElement('option');
                    opt.text = chapter.chapter_name;
                    opt.value = chapter.id;

                    $('#chapter_select').append(opt, null);
                }
                $('#chapter_select').select(0);
                $('#chapter_select').change();
            },
            error: function (data) {
                debugger;
            }
        });
        $.ajax({
            url: '<%=find_update_subjects_path%>',
            type: 'GET',
            dataType: 'json',
            data: {
                organization_id: selectedOrganization
            },
            success: function (data) {
                var subjects = data.subjects;
                debugger;

                $('#subject_select').empty();

                for (i = 0; i < subjects.length; i++) {
                    var subject = subjects[i];

                    var opt = document.createElement('option');
                    opt.text = subject.subject_name;
                    opt.value = subject.id;

                    $('#subject_select').append(opt, null);
                }
                $('#subject_select').select(0);
            },
            error: function (data) {
                debugger;
            }
        });
    });
    $('#chapter_select').change(function () {

        var selectedOrganization = $('#organization_select :selected').val();
        var selectedChapter = $('#chapter_select :selected').val();

        $.ajax({
            url: '<%=find_update_groups_path%>',
            type: 'GET',
            dataType: 'json',
            data: {
                organization_id: selectedOrganization,
                chapter_id: selectedChapter
            },
            success: function (data) {
                var groups = data.groups;
                debugger;

                $('#group_select').empty();
                var opt = document.createElement('option');
                opt.text = 'All';

                $('#group_select').append(opt, null);
                for (i = 0; i < groups.length; i++) {
                    var group = groups[i];

                    var opt = document.createElement('option');
                    opt.text = group.group_name;
                    opt.value = group.id;

                    $('#group_select').append(opt, null);
                }
                $('#group_select').select(0);
                $('#group_select').change();
            },
            error: function (data) {
                debugger;
            }
        });
    });

    $('#group_select').change(function () {

        var selectedOrganization = $('#organization_select :selected').val();
        var selectedChapter = $('#chapter_select :selected').val();
        var selectedGroup = $('#group_select :selected').val();

        $.ajax({
            url: '<%=find_update_students_path%>',
            type: 'GET',
            dataType: 'json',
            data: {
                organization_id: selectedOrganization,
                chapter_id: selectedChapter,
                group_id: selectedGroup
            },
            success: function (data) {
                var students = data.students;
                debugger;

                $('#student_select').empty();
                var opt = document.createElement('option');
                opt.text = 'All';

                $('#student_select').append(opt, null);
                for (i = 0; i < students.length; i++) {
                    var student = students[i];

                    var opt = document.createElement('option');
                    opt.text = student.last_name + ', ' + student.first_name;
                    opt.value = student.id;

                    $('#student_select').append(opt, null);
                }
            },
            error: function (data) {
                debugger;
            }
        });
    });

    $(function () {
        var charts = [],
            $containers = $('#trellis td'),
            datasets = <%= @series3.html_safe %>;

        $.each(datasets, function (i, dataset) {
            charts.push(new Highcharts.Chart({

                chart: {
                    renderTo: $containers[i],
                    type: 'scatter'
                },
                legend: {
                    enabled: true
                },
                credits: {
                    enabled: false
                },
                tooltip: {
                    valueDecimals: 2
                },
                title: {
                    text: dataset.skill
                },
                xAxis: {
                    title: {
                        text: '<%= t(:nr_of_lessons) %>'
                    }
                },
                yAxis: {
                    allowDecimals: false,
                    title: {
                        text: '<%= t(:performance)%>'
                    }
                },
                plotOptions: {
                    series: {
                        marker: {
                            radius: 2
                        }
                    }
                },
                series: dataset.series

            }));
        });
    });
</script>