<head>
  <script src="http://code.highcharts.com/highcharts.js"></script>
</head>
<h1>Analytics</h1>
<%#= @series9 %>

<%= form_tag do %>
    <table>
      <tr>
        <td style="padding-right: 20px;">
          <%= label_tag :organization_label, "Organization" %>
          <%= select_tag :organization_select, options_from_collection_for_select(@organizations, :id, :organization_name, @organization), :prompt => 'All' %>
        </td>
        <td style="padding-right: 20px;">
          <%= label_tag :chapter_label, "Chapter" %>
          <%= select_tag :chapter_select, options_from_collection_for_select(@chapters, :id, :chapter_name, @chapter), :prompt => 'All' %>
        </td>
        <td style="padding-right: 20px;">
          <%= label_tag :group_label, "Group" %>
          <%= select_tag :group_select, options_from_collection_for_select(@groups, :id, :group_name, @group), :prompt => 'All' %>
        </td>
        <td style="padding-right: 20px;">
          <%= label_tag :student_label, "Student" %>
          <%= select_tag :student_select, options_from_collection_for_select(@students, :id, :proper_name, @student), :prompt => 'All' %>
        </td>
        <td style="padding-right: 20px;">
          <%= submit_tag "Submit" %>
        </td>
      </tr>
    </table>
<% end %>

<table style="width: 100%; table-layout: fixed;">
  <tr>
    <td style="width: 50%;">
      <div id="chart2" style="width:100%; height:400px;"></div>
    </td>
    <td style="width: 50%;">
      <div id="chart4" style="width:100%; height:400px;"></div>
    </td>
  </tr>
  <tr>
    <td style="width: 50%;">
      <div id="chart5" style="width:100%; height:400px;"></div>
    </td>
    <td style="width: 50%;">
      <div id="chart6" style="width:100%; height:400px;"></div>
    </td>
  </tr>
  <tr>
    <td style="width: 50%;">
      <div id="chart8" style="width:100%; height:400px;"></div>
    </td>
    <td style="width: 50%;">
      <div id="chart9" style="width:100%; height:400px;"></div>
    </td>
  </tr>
</table>

<script>
    $('#organization_select').change(function () {

        var selectedOrganization = $('#organization_select :selected').val();
        var selectedChapter = $('#chapter_select :selected').val();
        var selectedGroup = $('#group_select :selected').val();
        console.debug(selectedOrganization);

        $.ajax({
            url: '<%=find_update_chapters_path%>',
            type: 'GET',
            dataType: 'json',
            data: {
                organization_id: selectedOrganization,
                chapter_id: selectedChapter,
                group_id: selectedGroup
            },
            success: function (data) {
                var chapters = data.chapters;
                debugger;

                $('#chapter_select').empty();
                var opt = document.createElement('option');
                opt.text = 'All';
                $('#chapter_select').append(opt, null);

                for (i = 0; i < chapters.length; i++) {
                    var chapter = chapters[i];

                    var opt = document.createElement('option');
                    opt.text = chapter.chapter_name;
                    opt.value = chapter.id;

                    $('#chapter_select').append(opt, null);
                }
                $('#chapter_select').select(0);
                $('#chapter_select').change();
            },
            error: function (data) {
                debugger;
            }
        });
    });
    $('#chapter_select').change(function () {

        var selectedOrganization = $('#organization_select :selected').val();
        var selectedChapter = $('#chapter_select :selected').val();
        var selectedGroup = $('#group_select :selected').val();

        $.ajax({
            url: '<%=find_update_groups_path%>',
            type: 'GET',
            dataType: 'json',
            data: {
                organization_id: selectedOrganization,
                chapter_id: selectedChapter,
                group_id: selectedGroup
            },
            success: function (data) {
                var groups = data.groups;
                debugger;

                $('#group_select').empty();
                var opt = document.createElement('option');
                opt.text = 'All';

                $('#group_select').append(opt, null);
                for (i = 0; i < groups.length; i++) {
                    var group = groups[i];

                    var opt = document.createElement('option');
                    opt.text = group.group_name;
                    opt.value = group.id;

                    $('#group_select').append(opt, null);
                }
                $('#group_select').select(0);
                $('#group_select').change();
            },
            error: function (data) {
                debugger;
            }
        });
    });

    $('#group_select').change(function () {

        var selectedOrganization = $('#organization_select :selected').val();
        var selectedChapter = $('#chapter_select :selected').val();
        var selectedGroup = $('#group_select :selected').val();

        $.ajax({
            url: '<%=find_update_students_path%>',
            type: 'GET',
            dataType: 'json',
            data: {
                organization_id: selectedOrganization,
                chapter_id: selectedChapter,
                group_id: selectedGroup
            },
            success: function (data) {
                var students = data.students;
                debugger;

                $('#student_select').empty();
                var opt = document.createElement('option');
                opt.text = 'All';

                $('#student_select').append(opt, null);
                for (i = 0; i < students.length; i++) {
                    var student = students[i];

                    var opt = document.createElement('option');
                    opt.text = student.last_name + ', ' + student.first_name;
                    opt.value = student.id;

                    $('#student_select').append(opt, null);
                }
            },
            error: function (data) {
                debugger;
            }
        });
    });

    $(function () {

        var Chart2 = Highcharts.chart('chart2', {
            chart: {
                type: 'column'
            },
            legend: {
                enabled: false
            },
            credits: {
                enabled: false
            },
            title: {
                text: '<%= t(:title_chart_2)%>'
            },
            xAxis: {
                title: {
                    text: '<%= t(:month) %>'
                },
                categories: <%= @categories2.html_safe %>
            },
            yAxis: {
                title: {
                    text: '<%= t(:nr_of_assessments) %>'
                }
            },
            series: <%= @series2.html_safe %>
        });

        var Chart4 = Highcharts.chart('chart4', {
            chart: {
                type: 'column'
            },
            legend: {
                enabled: false
            },
            credits: {
                enabled: false
            },
            tooltip: {
                valueDecimals: 1
            },
            title: {
                text: '<%= t(:title_chart_4)%>'
            },
            xAxis: {
                title: {
                    text: '<%= t(:performance) %>'
                }
            },
            yAxis: {
                title: {
                    text: '<%= t(:frequency_perc) %>'
                }
            },
            series: <%= @series4.html_safe %>
        });

        var Chart5 = Highcharts.chart('chart5', {
            chart: {
                type: 'column'
            },
            legend: {
                enabled: false
            },
            credits: {
                enabled: false
            },
            tooltip: {
                valueDecimals: 1
            },
            title: {
                text: '<%= t(:title_chart_5)%>'
            },
            xAxis: {
                title: {
                    text: '<%= t(:performance_change) %>'
                }
            },
            yAxis: {
                title: {
                    text: '<%= t(:frequency_perc) %>'
                }
            },
            series: <%= @series5.html_safe %>
        });

        var Chart6 = Highcharts.chart('chart6', {
            chart: {
                type: 'column'
            },
            legend: {
                enabled: true
            },
            credits: {
                enabled: false
            },
            tooltip: {
                valueDecimals: 1
            },
            title: {
                text: '<%= t(:title_chart_6)%>'
            },
            xAxis: {
                title: {
                    text: '<%= t(:performance_change) %>'
                }
            },
            yAxis: {
                title: {
                    text: '<%= t(:frequency_perc) %>'
                }
            },
            series: <%= @series6.html_safe %>
        });

        var Chart8 = Highcharts.chart('chart8', {
            chart: {
                type: 'scatter'
            },
            legend: {
                enabled: true
            },
            credits: {
                enabled: false
            },
            tooltip: {
                valueDecimals: 2
            },
            title: {
                text: '<%= t(:title_chart_8)%>'
            },
            xAxis: {
                title: {
                    text: '<%= t(:nr_of_lessons) %>'
                }
            },
            yAxis: {
                title: {
                    text: '<%= t(:performance)%>'
                }
            },
            plotOptions: {
                series: {
                    marker: {
                        radius: 2
                    }
                }
            },
            series: <%= @series10.html_safe %>
        });

        var Chart9 = Highcharts.chart('chart9', {
            chart: {
                type: 'scatter'
            },
            legend: {
                enabled: true
            },
            credits: {
                enabled: false
            },
            tooltip: {
                valueDecimals: 2,
                formatter: function () {

                    return "<span style='color:" + this.color + ";'>\u25CF</span><span style='font-size: smaller'> " + this.series.name + "</span><br/>"
                        + this.point.name + "<br/>"
                        + "x: <b>" + this.x + "</b><br/>"
                        + "y: <b>" + Highcharts.numberFormat(this.y, 2) + "</b>";
                },
                useHTML: true
            },
            title: {
                text: '<%= t(:title_chart_9)%>'
            },
            xAxis: {
                title: {
                    text: '<%= t(:nr_of_lessons) %>'
                }
            },
            yAxis: {
                title: {
                    text: '<%= t(:performance) %>'
                }
            },
            plotOptions: {
                series: {
                    marker: {
                        radius: 2
                    }
                }
            },
            series: <%= @series9.html_safe %>
        });
    });
</script>
